<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#060810" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Puter AI Studio Pro</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" id="hl-theme" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root{
      --bg0:#060810;--bg1:#090c18;--bg2:#0d1225;
      --card:rgba(255,255,255,0.048);--card-h:rgba(255,255,255,0.075);
      --stroke:rgba(255,255,255,0.09);--stroke2:rgba(255,255,255,0.16);
      --text:#e8eeff;--muted:rgba(232,238,255,0.62);--muted2:rgba(232,238,255,0.44);
      --shadow:0 28px 100px rgba(0,0,0,0.65);--shadow2:0 10px 36px rgba(0,0,0,0.40);
      --accent:#7b5fff;--accent2:#00d8ff;--ok:#22d392;--warn:#ffb224;--bad:#ff4a6a;
      --mono:'JetBrains Mono', ui-monospace, monospace;--sans:'Sora', ui-sans-serif, system-ui, sans-serif;
      --r1:24px;--r2:16px;--r3:12px;--r4:8px;
      --focus:rgba(123,95,255,0.5);
      --glass:rgba(255,255,255,0.048);--glass2:rgba(255,255,255,0.075);
      --sel:rgba(123,95,255,0.18);--sel2:rgba(0,216,255,0.12);
      --ease:cubic-bezier(0.22,1,0.36,1);
    }
    html[data-theme="light"]{
      --bg0:#f2f4fc;--bg1:#eaedfa;--bg2:#e2e7f7;
      --card:rgba(10,18,60,0.045);--card-h:rgba(10,18,60,0.07);
      --stroke:rgba(10,18,60,0.09);--stroke2:rgba(10,18,60,0.16);
      --text:#0b1022;--muted:rgba(11,16,34,0.65);--muted2:rgba(11,16,34,0.48);
      --shadow:0 20px 70px rgba(0,0,0,0.12);--shadow2:0 8px 28px rgba(0,0,0,0.09);
      --glass:rgba(10,18,60,0.038);--glass2:rgba(10,18,60,0.062);
      --sel:rgba(123,95,255,0.12);--sel2:rgba(0,216,255,0.09);
    }

    *,*::before,*::after{box-sizing:border-box;}
    html,body{height:100%;margin:0;overflow-x:hidden;}
    body{
      font-family:var(--sans);font-size:13px;color:var(--text);
      background:
        radial-gradient(ellipse 1300px 700px at 18% -4%, rgba(123,95,255,0.15), transparent 62%),
        radial-gradient(ellipse 900px 600px at 90% 14%, rgba(0,216,255,0.12), transparent 58%),
        radial-gradient(ellipse 800px 700px at 38% 130%, rgba(34,211,146,0.06), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding:16px;min-height:100vh;
      display:flex; flex-direction:column;
    }

    .app{
      width:min(1600px,100%);margin:0 auto;border:1px solid var(--stroke);
      border-radius:calc(var(--r1) + 6px);
      background:linear-gradient(170deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      box-shadow:var(--shadow);overflow:hidden;
      backdrop-filter:blur(18px) saturate(1.4);-webkit-backdrop-filter:blur(18px) saturate(1.4);
      animation:appIn .4s var(--ease) both;
      display:flex; flex-direction:column; flex:1;
    }
    @keyframes appIn{from{opacity:0;transform:translateY(18px) scale(0.99);}to{opacity:1;transform:none;}}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:13px 16px;border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,0.065), rgba(255,255,255,0.02));
      flex-shrink:0;
    }
    .brand{display:flex;align-items:center;gap:12px;}
    .mark{
      width:36px;height:36px;border-radius:12px;flex-shrink:0;
      background:radial-gradient(16px 16px at 30% 28%, rgba(255,255,255,0.52), transparent 58%), linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow:0 10px 28px rgba(123,95,255,0.28);
      border:1px solid rgba(255,255,255,0.2);
      position:relative;overflow:hidden;
    }
    .mark::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg, transparent 60%, rgba(255,255,255,0.08));}
    .brand-text h1{margin:0;font-size:14px;font-weight:800;letter-spacing:0.2px;}
    .brand-text .sub{margin-top:2px;font-size:10.5px;color:var(--muted2);letter-spacing:0.15px;}
    .top-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;}

    button{font-family:var(--sans);cursor:pointer;}
    .btn{
      display:inline-flex;align-items:center;gap:6px;border:1px solid var(--stroke);
      background:var(--glass);color:var(--text);padding:8px 12px;border-radius:var(--r3);
      font-size:12px;font-weight:500;transition:all .15s var(--ease);
      user-select:none;white-space:nowrap;
    }
    .btn:hover{background:var(--glass2);border-color:var(--stroke2);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,0.2);}
    .btn:active{transform:translateY(0);}
    .btn:disabled{opacity:0.46;cursor:not-allowed;transform:none!important;box-shadow:none!important;}
    .btn.primary{
      background:linear-gradient(135deg, rgba(123,95,255,0.9), rgba(0,216,255,0.82));
      border-color:rgba(255,255,255,0.2);box-shadow:0 14px 40px rgba(123,95,255,0.2);
      color:#fff;font-weight:600;
    }
    .btn.primary:hover{background:linear-gradient(135deg, rgba(123,95,255,1), rgba(0,216,255,0.95));box-shadow:0 16px 48px rgba(123,95,255,0.3);}
    .btn.ghost{background:transparent;border-color:transparent;}
    .btn.ghost:hover{background:var(--glass);border-color:var(--stroke);}
    .btn.danger{background:rgba(255,74,106,0.1);border-color:rgba(255,74,106,0.32);color:var(--bad);}
    .btn.danger:hover{background:rgba(255,74,106,0.18);border-color:rgba(255,74,106,0.52);}
    .btn.icon{padding:7px;border-radius:10px;}
    .btn.sm{padding:6px 10px;font-size:11px;}

    .pill{
      display:inline-flex;align-items:center;gap:7px;border:1px solid var(--stroke);
      background:var(--glass);padding:7px 11px;border-radius:999px;font-size:11.5px;color:var(--muted);
    }
    .dot{
      width:7px;height:7px;border-radius:50%;background:var(--warn);
      box-shadow:0 0 0 3px rgba(255,178,36,0.14);transition:background .3s,box-shadow .3s;
    }
    .dot.ok{background:var(--ok);box-shadow:0 0 0 3px rgba(34,211,146,0.16);}
    .dot.bad{background:var(--bad);box-shadow:0 0 0 3px rgba(255,74,106,0.16);}

    .grid{display:grid;grid-template-columns:380px 1fr;flex:1;min-height:0;}
    @media (max-width:900px){
      .grid{grid-template-columns:1fr;display:flex;flex-direction:column;}
      .sidebar{display:none;}
      .sidebar.mobile-open{display:block; flex-shrink:0;}
    }

    .sidebar{
      padding:14px;border-right:1px solid var(--stroke);background:rgba(255,255,255,0.012);
      transition:width .18s var(--ease);overflow-y:auto;
    }
    .sidebar.collapsed{width:78px;padding:12px 8px;}
    .sidebar.collapsed .hide-collapsed{display:none!important;}
    .sidebar.collapsed .card{border-radius:var(--r2);}
    .sidebar.collapsed .card .head{justify-content:center;}
    .sidebar.collapsed .card .head .hint{display:none;}

    .card{
      border:1px solid var(--stroke);background:var(--card);border-radius:var(--r1);
      box-shadow:var(--shadow2);overflow:hidden;transition:border-color .15s;
    }
    .card + .card{margin-top:12px;}
    .card .head{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      padding:11px 13px 10px;border-bottom:1px solid var(--stroke);background:rgba(255,255,255,0.035);
    }
    .title{font-size:11.5px;font-weight:700;letter-spacing:0.3px;text-transform:uppercase;}
    .hint{font-size:10.5px;color:var(--muted2);}
    .body{padding:13px;}

    label{
      display:block;font-size:10.5px;font-weight:600;color:var(--muted);
      margin-bottom:5px;letter-spacing:0.3px;text-transform:uppercase;
    }
    textarea,input[type="text"],input[type="number"],select{
      width:100%;border:1px solid var(--stroke);border-radius:var(--r3);
      background:rgba(255,255,255,0.02);color:var(--text);
      padding:9px 11px;outline:none;font-size:12.5px;font-family:var(--sans);
      transition:border-color .15s,background .15s,box-shadow .15s;
    }
    textarea:focus,input:focus,select:focus{
      border-color:var(--focus);background:rgba(255,255,255,0.05);
      box-shadow:0 0 0 3px rgba(123,95,255,0.12);
    }
    textarea{resize:vertical;min-height:60px;line-height:1.55;field-sizing:content;}
    select{appearance:none;cursor:pointer;}

    .row{display:flex;gap:9px;align-items:flex-end;}
    .row + .row{margin-top:10px;}
    .col{flex:1;min-width:0;}
    .col.sm{flex:0 0 140px;}

    .select-wrap{position:relative;}
    .select-wrap select{padding-right:28px;}
    .select-wrap::after{
      content:'‚åÉ';position:absolute;right:10px;top:50%;
      transform:translateY(-50%) rotate(180deg);
      color:var(--muted2);pointer-events:none;font-size:12px;
    }

    .toggle-row{
      display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--stroke);
      border-radius:var(--r3);background:rgba(255,255,255,0.02);font-size:12px;color:var(--muted);
      user-select:none;cursor:pointer;transition:background .12s,border-color .12s;
    }
    .toggle-row:hover{background:rgba(255,255,255,0.05);border-color:var(--stroke2);}
    .toggle-row input{width:auto;margin:0;accent-color:var(--accent);cursor:pointer;}
    .toggle-row .tgl-desc{margin-left:auto;font-size:10.5px;color:var(--muted2);}

    .sep{height:1px;background:var(--stroke);margin:11px 0;}
    .kbd{
      font-family:var(--mono);font-size:10.5px;color:var(--muted2);
      border:1px solid var(--stroke);background:rgba(255,255,255,0.04);
      padding:2px 6px;border-radius:7px;
    }
    .meta-line{
      font-size:10.5px;color:var(--muted2);margin-top:7px;
      display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;
    }
    .char-counter{
      font-size:10.5px;color:var(--muted2);text-align:right;margin-top:4px;
      font-family:var(--mono);transition:color .2s;
    }
    .char-counter.warn{color:var(--warn);}

    .main{display:flex;flex-direction:column;background:rgba(255,255,255,0.005);flex:1;min-width:0;}
    .tabs{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:11px 14px;border-bottom:1px solid var(--stroke);
      background:rgba(255,255,255,0.025);flex-wrap:wrap;
    }
    .tab-left{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
    .tab{
      border:1px solid var(--stroke);background:rgba(255,255,255,0.038);color:var(--muted);
      padding:7px 13px;border-radius:999px;font-size:12px;font-weight:500;
      cursor:pointer;user-select:none;transition:all .14s;
    }
    .tab:hover{background:rgba(255,255,255,0.062);color:var(--text);}
    .tab.active{
      background:linear-gradient(135deg, var(--sel), var(--sel2));
      border-color:rgba(123,95,255,0.36);color:var(--text);
    }
    .tab-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .status-line{font-size:11px;color:var(--muted2);display:flex;align-items:center;gap:8px;}

    .loader{display:none;align-items:center;gap:8px;font-size:11.5px;color:var(--muted);}
    .loader.on{display:flex;}
    .spin{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(255,255,255,0.14);border-top-color:var(--accent);
      animation:spin .72s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}

    .view{display:none;flex:1 1 auto; overflow-y:auto;}
    .view.active{display:flex;flex-direction:column;}

    .chat-body{padding:16px 20px;overflow-y:auto;flex:1 1 auto;scroll-behavior:smooth;}
    .msg{display:flex;gap:12px;margin-bottom:20px;animation:msgIn .3s var(--ease) both;}
    @keyframes msgIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:none;}}
    .avatar{
      width:32px;height:32px;border-radius:10px;border:1px solid var(--stroke);
      background:rgba(255,255,255,0.06);
      display:flex;align-items:center;justify-content:center;
      font-size:11px;font-weight:700;color:var(--muted);flex-shrink:0;font-family:var(--mono);
    }
    .msg.user .avatar{
      background:linear-gradient(135deg, rgba(123,95,255,0.25), rgba(0,216,255,0.18));
      border-color:rgba(123,95,255,0.28);color:var(--accent2);
    }
    .msg.assistant .avatar{
      background:linear-gradient(135deg, rgba(34,211,146,0.18), rgba(0,216,255,0.12));
      border-color:rgba(34,211,146,0.24);color:var(--ok);
    }
    .msg-content{flex:1;min-width:0;max-width:900px;}
    
    .bubble{
      border:1px solid var(--stroke);background:var(--card);
      border-radius:4px 18px 18px 18px;
      padding:14px 18px;line-height:1.6;font-size:13.5px;
      white-space:normal;word-break:break-word;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .msg.user .bubble{
      background:linear-gradient(135deg, rgba(123,95,255,0.12), rgba(0,216,255,0.08));
      border-color:rgba(123,95,255,0.22);
      border-radius:18px 4px 18px 18px;
    }
    
    .msg-actions{display:flex;gap:8px;align-items:center;margin-top:8px;opacity:0.3;transition:opacity .2s;}
    .msg:hover .msg-actions{opacity:1;}

    .chat-foot{
      padding:12px 14px;border-top:1px solid var(--stroke);
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;background:rgba(255,255,255,0.015);
      flex-shrink: 0;
    }

    .prompt-wrap{position:relative;}
    .prompt-wrap textarea{padding-right:36px;}

    /* --- Compare Wrap --- */
    .compare-wrap{
      padding:14px;display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:12px;align-items:start;overflow:auto; flex:1;
    }
    @media (max-width:900px){.compare-wrap{grid-template-columns:1fr;}}
    .cmp-card{
      border:1px solid var(--stroke);background:var(--card);border-radius:var(--r1);
      box-shadow:var(--shadow2);display:flex;flex-direction:column;height:100%; min-height:440px;
      transition:border-color .3s;
    }
    .cmp-card.winner{border-color:rgba(34,211,146,0.42);}
    .cmp-card.loser{border-color:rgba(255,74,106,0.28);}
    .cmp-head{
      padding:11px 13px;border-bottom:1px solid var(--stroke);
      display:flex;justify-content:space-between;gap:10px;background:rgba(255,255,255,0.028);align-items:center;
    }
    .cmp-title{font-weight:700;font-size:12px;letter-spacing:.2px;}
    .cmp-title span{
      display:block;font-weight:500;color:var(--muted);
      font-size:10.5px;margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:300px;
    }
    .cmp-body{padding:13px;flex:1 1 auto;overflow:auto;}
    .cmp-out{font-size:13px;line-height:1.6;white-space:normal;word-break:break-word;}
    .cmp-meta{
      padding:9px 13px;border-top:1px solid var(--stroke);background:rgba(255,255,255,0.015);
      display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;
      color:var(--muted2);font-size:10.5px;font-family:var(--mono);
    }
    .verdict-badge{font-size:10.5px;font-weight:700;padding:3px 9px;border-radius:999px;display:none;}
    .verdict-badge.win{background:rgba(34,211,146,0.16);color:var(--ok);border:1px solid rgba(34,211,146,0.3);}
    .verdict-badge.loss{background:rgba(255,74,106,0.12);color:var(--bad);border:1px solid rgba(255,74,106,0.28);}

    /* --- Image Generation Wrap --- */
    .image-wrap{
      padding:20px; display:flex; flex-direction:column; gap:20px; flex:1; overflow-y:auto;
    }
    .image-controls{
      display:flex; gap:10px; align-items:flex-end; max-width: 800px;
    }
    .img-grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:20px;
    }
    .img-card{
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--r2);
      overflow:hidden; box-shadow:var(--shadow2); animation:fadeIn .3s; display:flex; flex-direction:column;
    }
    .img-card img{width:100%; height:auto; display:block;}
    .img-card .img-prompt{padding:12px; font-size:11.5px; color:var(--muted); font-style:italic;}

    /* --- Logs --- */
    .logs-wrap{padding:14px;display:flex;flex-direction:column;gap:12px;overflow:auto; flex:1;}
    .log-box{
      border:1px solid var(--stroke);background:rgba(0,0,0,0.22);border-radius:var(--r1);
      padding:13px;font-family:var(--mono);font-size:11px;color:var(--muted);
      white-space:pre-wrap;word-break:break-word;flex:1;overflow-y:auto;line-height:1.6;
    }
    html[data-theme="light"] .log-box{background:rgba(10,18,60,0.055);}
    .log-line-err{color:var(--bad);} .log-line-ok{color:var(--ok);} .log-line-warn{color:var(--warn);}

    .err-box{
      display:none;margin-top:10px;border:1px solid rgba(255,74,106,0.32);
      background:rgba(255,74,106,0.08);border-radius:var(--r3);
      padding:10px;font-family:var(--mono);font-size:11px;white-space:pre-wrap;word-break:break-word;color:var(--text);
      animation:fadeIn .2s ease;
    }
    .err-box.on{display:block;}

    /* --- Toast --- */
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%) translateY(16px);
      background:rgba(8,10,24,0.88);backdrop-filter:blur(10px);color:#fff;
      padding:9px 14px;border-radius:var(--r3);border:1px solid rgba(255,255,255,0.14);
      font-size:12px;font-family:var(--sans);display:block;max-width:min(880px,92vw);
      box-shadow:0 14px 46px rgba(0,0,0,0.4);z-index:99999;opacity:0;pointer-events:none;
      transition:opacity .22s var(--ease), transform .22s var(--ease);
    }
    .toast.on{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto;}
    .toast.err{border-color:rgba(255,74,106,0.45);background:rgba(30,8,14,0.9);}
    .toast.ok{border-color:rgba(34,211,146,0.42);background:rgba(4,24,16,0.9);}
    .toast.warn{border-color:rgba(255,178,36,0.42);background:rgba(24,18,4,0.9);}
    html[data-theme="light"] .toast{background:rgba(10,16,40,0.9);}

    /* --- Markdown Styles --- */
    .md p, .md ul, .md ol { margin-top:0; margin-bottom: 12px; }
    .md p:last-child { margin-bottom: 0; }
    .md h1, .md h2, .md h3, .md h4 { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 700; color: var(--text); }
    .md h1 { font-size: 1.4em; }
    .md h2 { font-size: 1.25em; border-bottom: 1px solid var(--stroke); padding-bottom: 4px;}
    .md h3 { font-size: 1.1em; }
    .md code {
      font-family: var(--mono); font-size: 0.85em;
      background: rgba(123,95,255,0.15); color: #b4a2ff;
      padding: 2px 5px; border-radius: 4px;
    }
    html[data-theme="light"] .md code { background: rgba(123,95,255,0.1); color: #5b3ce8;}
    
    .md pre {
      background: #0d1117; /* GitHub dark bg */
      border: 1px solid var(--stroke); border-radius: 8px;
      padding: 12px; overflow-x: auto; margin: 14px 0;
      position: relative; /* for copy button */
    }
    html[data-theme="light"] .md pre { background: #f6f8fa; border-color: #d0d7de; }
    .md pre code {
      background: transparent; color: inherit; padding: 0; border-radius: 0;
      font-size: 13px; line-height: 1.5; white-space: pre;
    }
    
    .md blockquote {
      border-left: 4px solid var(--accent); margin: 0 0 14px 0; padding: 4px 14px;
      color: var(--muted); background: var(--glass); border-radius: 0 6px 6px 0;
    }
    .md a { color: var(--accent2); text-decoration: none; }
    .md a:hover { text-decoration: underline; }
    .md table { width: 100%; border-collapse: collapse; margin-bottom: 14px; }
    .md th, .md td { border: 1px solid var(--stroke); padding: 8px 12px; text-align: left; }
    .md th { background: var(--glass); }

    /* Copy Code Button */
    .copy-code-btn {
      position: absolute; top: 6px; right: 6px;
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      color: #fff; font-size: 10px; padding: 4px 8px; border-radius: 4px;
      cursor: pointer; opacity: 0; transition: opacity 0.2s;
    }
    .md pre:hover .copy-code-btn { opacity: 1; }
    .copy-code-btn:hover { background: rgba(255,255,255,0.2); }

    .empty-state{
      flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:12px;padding:40px;color:var(--muted2);text-align:center; height:100%;
    }
    .empty-state .icon{font-size:48px;opacity:0.5;animation:float 3s ease-in-out infinite;}
    @keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}

    ::-webkit-scrollbar{width:8px;height:8px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:var(--stroke2);border-radius:99px;}
    ::-webkit-scrollbar-thumb:hover{background:rgba(123,95,255,0.4);}
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="mark"></div>
      <div class="brand-text">
        <h1>Puter AI Studio Pro</h1>
        <div class="sub">Chat ¬∑ Compare ¬∑ Images ¬∑ Github Pages Edition</div>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn ghost icon" id="btnCollapse" title="Colapsar sidebar (Ctrl+B)">‚ò∞</button>
      <div class="pill" id="authPill">
        <span class="dot" id="authDot"></span>
        <span id="authText">SDK carregando‚Ä¶</span>
      </div>
      <button class="btn sm" id="btnSignIn">Entrar</button>
      <button class="btn sm" id="btnReload">‚Üª Modelos</button>
      <button class="btn sm" id="btnTheme">‚óë Tema</button>
    </div>
  </div>

  <div class="grid">
    <div class="sidebar" id="sidebar">
      <div class="card">
        <div class="head">
          <div class="title">Prompt Setup</div>
          <div class="hint hide-collapsed"><span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> envia</div>
        </div>
        <div class="body hide-collapsed">
          <label for="system">System prompt</label>
          <textarea id="system" placeholder="Ex.: Voc√™ √© um engenheiro de software experiente. Responda em portugu√™s com exemplos de c√≥digo claros."></textarea>

          <div style="height:10px"></div>

          <label for="prompt">Mensagem (User)</label>
          <div class="prompt-wrap">
            <textarea id="prompt" placeholder="Digite sua pergunta‚Ä¶ (‚Üë‚Üì para hist√≥rico)" rows="3"></textarea>
            <span class="prompt-history-hint">‚Üë‚Üì</span>
          </div>
          <div class="meta-line">
            <span id="tokenCounter" title="Estimativa bruta de tokens (chars/4)">~ 0 tokens</span>
            <span class="char-counter" id="charCounter">0 chars</span>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn primary col" id="btnSend">‚ñ∂ Enviar</button>
            <button class="btn col" id="btnRegen" title="Regenerar √∫ltima resposta">‚Ü∫ Regen</button>
            <button class="btn col" id="btnStop" disabled>‚ñ† Parar</button>
          </div>
          <div class="row">
            <button class="btn col" id="btnClear">Limpar</button>
            <button class="btn col" id="btnExport">Exportar</button>
          </div>

          <div class="err-box" id="errBox"></div>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <div class="title">Modelos</div>
          <div class="hint hide-collapsed"><span id="modelCount">‚Äî</span></div>
        </div>
        <div class="body hide-collapsed">
          <div class="row">
            <div class="col select-wrap">
              <input id="modelSearch" type="text" placeholder="Buscar (ex: claude, gpt)‚Ä¶" autocomplete="off" />
              <button class="clear-btn" id="btnClearSearch" title="Limpar busca">√ó</button>
            </div>
          </div>
          <div class="row">
            <div class="col select-wrap">
              <select id="providerFilter"></select>
            </div>
            <div class="col select-wrap">
              <select id="sortBy">
                <option value="recommended">Recomendado</option>
                <option value="alpha">A ‚Üí Z</option>
                <option value="context_desc">Maior contexto</option>
                <option value="cost_in_asc">Mais barato</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <select id="modelSelect" size="6"></select>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <div class="col sm">
              <label for="optMaxTokens">Max tokens</label>
              <input id="optMaxTokens" type="number" min="16" step="64" placeholder="auto" />
            </div>
            <div class="col">
              <label for="optTemp">Temperature</label>
              <input id="optTemp" type="number" min="0" max="2" step="0.1" value="0.7" />
            </div>
          </div>
          
          <div style="height:10px"></div>
          <label class="toggle-row">
            <input type="checkbox" id="optStream" checked />
            <span>Streaming (resposta em tempo real)</span>
          </label>

          <div class="sep"></div>
          <label for="compareSelect">Compare (m√°x. 2)</label>
          <select id="compareSelect" multiple size="4"></select>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="tabs">
        <div class="tab-left">
          <div class="tab active" data-tab="chat">üí¨ Chat</div>
          <div class="tab" data-tab="compare">‚öñÔ∏è Compare</div>
          <div class="tab" data-tab="image">üé® Imagens</div>
          <div class="tab" data-tab="logs">üìã Logs</div>
        </div>
        <div class="tab-right">
          <div class="status-line" id="runMeta">Pronto.</div>
          <div class="loader" id="loader">
            <div class="spin"></div>
            <span id="loaderText">Processando‚Ä¶</span>
          </div>
        </div>
      </div>

      <div class="view active" id="view-chat">
        <div class="chat-body" id="chatBody">
          <div class="empty-state" id="emptyState">
            <div class="icon">‚ú®</div>
            <p><strong>Pronto para come√ßar.</strong><br>O Markdown avan√ßado e o highlight de c√≥digo j√° est√£o ativos. Digite sua pergunta e vamos programar.</p>
          </div>
        </div>
        <div class="chat-foot">
          <div style="font-size:11px;color:var(--muted2);">
            <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> envia ¬∑ <span class="kbd">‚Üë</span><span class="kbd">‚Üì</span> hist√≥rico
          </div>
          <div style="font-size:11px;color:var(--muted2);font-family:var(--mono);" id="footMeta">‚Äî</div>
        </div>
      </div>

      <div class="view" id="view-compare">
        <div class="compare-wrap" id="compareWrap">
          <div class="cmp-card" id="cmpCardA">
            <div class="cmp-head">
              <div class="cmp-title">Modelo A <span id="cmpAName">‚Äî</span></div>
              <div style="display:flex;gap:8px;align-items:center;">
                <span class="verdict-badge" id="verdictA">‚Äî</span>
                <button class="btn sm primary" id="btnRunCompare">‚ñ∂ Comparar</button>
              </div>
            </div>
            <div class="cmp-body"><div class="cmp-out md" id="cmpAOut">Selecione 2 modelos no painel esquerdo.</div></div>
            <div class="cmp-meta" id="cmpAMeta">‚Äî</div>
          </div>

          <div class="cmp-card" id="cmpCardB">
            <div class="cmp-head">
              <div class="cmp-title">Modelo B <span id="cmpBName">‚Äî</span></div>
              <div style="display:flex;gap:8px;align-items:center;">
                <span class="verdict-badge" id="verdictB">‚Äî</span>
                <button class="btn sm" id="btnSwapCompare">‚Üî Trocar</button>
              </div>
            </div>
            <div class="cmp-body"><div class="cmp-out md" id="cmpBOut">‚Äî</div></div>
            <div class="cmp-meta" id="cmpBMeta">‚Äî</div>
          </div>
        </div>
        <div class="chat-foot">
          <div style="font-size:11px;color:var(--muted2);">As requisi√ß√µes rodam em paralelo.</div>
          <div style="font-size:11px;color:var(--muted2);font-family:var(--mono);" id="cmpFoot">‚Äî</div>
        </div>
      </div>

      <div class="view" id="view-image">
        <div class="image-wrap">
          <div class="image-controls">
            <div class="col">
              <label>Prompt da Imagem</label>
              <textarea id="imgPrompt" placeholder="Ex: Um cachorro astronauta em marte, arte digital, 4k" rows="2"></textarea>
            </div>
            <button class="btn primary" style="height: 52px; padding: 0 24px;" id="btnGenerateImage">Gerar Imagem</button>
          </div>
          <div class="img-grid" id="imgGrid">
             <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="icon">üñºÔ∏è</div>
                <p>Nenhuma imagem gerada ainda.<br>Use a ferramenta do Puter.js para text-to-image.</p>
             </div>
          </div>
        </div>
      </div>

      <div class="view" id="view-logs">
        <div class="logs-wrap">
          <div class="row" style="flex:0;">
            <button class="btn sm" id="btnCopyLogs">Copiar logs</button>
            <button class="btn sm danger" id="btnClearLogs">Limpar</button>
          </div>
          <div class="log-box" id="logBox">Sess√£o iniciada...\n</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://js.puter.com/v2/" defer></script>

<script>
const $  = (id) => document.getElementById(id);

const APP = {
  LS_KEY: "puter_ai_studio_pro_v4",
  EXPORT_DEFAULT: () => `puter-ai-${Date.now()}.json`,
};

// ‚îÄ‚îÄ‚îÄ Setup Markdown (Marked + Highlight.js) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
marked.setOptions({
  highlight: function(code, lang) {
    if (lang && hljs.getLanguage(lang)) {
      try { return hljs.highlight(code, { language: lang }).value; } catch (__) {}
    }
    return hljs.highlightAuto(code).value; // fallback
  },
  breaks: true,
  gfm: true
});

function mdToHtml(md) {
  return marked.parse(md || "");
}

// Injetar bot√µes de copiar nos blocos de c√≥digo
function attachCopyButtons(containerElement) {
  containerElement.querySelectorAll('pre').forEach(pre => {
    if (pre.querySelector('.copy-code-btn')) return; // J√° tem bot√£o
    const btn = document.createElement('button');
    btn.className = 'copy-code-btn';
    btn.innerText = 'üìã Copiar';
    btn.onclick = async () => {
      const code = pre.querySelector('code').innerText;
      await copyText(code);
      btn.innerText = '‚úì Copiado';
      setTimeout(() => btn.innerText = 'üìã Copiar', 2000);
    };
    pre.appendChild(btn);
  });
}

const delay = (ms) => new Promise(r => setTimeout(r, ms));

// ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _toastTimer = null;
function toast(msg, type = "info", ms = 2800) {
  const el = $("toast");
  el.textContent = msg;
  el.className = "toast on" + (type !== "info" ? " " + type : "");
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => el.classList.remove("on"), ms);
}

function stamp() {
  return new Date().toLocaleTimeString('pt-BR');
}

function logLine(line, level = "info") {
  const box = $("logBox");
  const classes = { error: "log-line-err", ok: "log-line-ok", warn: "log-line-warn" };
  const span = document.createElement("span");
  if (classes[level]) span.className = classes[level];
  span.textContent = `[${stamp()}] ${line}\n`;
  box.appendChild(span);
  box.scrollTop = box.scrollHeight;
}

// ‚îÄ‚îÄ‚îÄ Puter Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function waitForPuter(ms = 15000) {
  const t0 = Date.now();
  while (Date.now() - t0 < ms) {
    if (window.puter?.ai?.chat) return true;
    await delay(100);
  }
  return false;
}

async function isSignedIn() {
  try { return await puter.auth.isSignedIn(); } catch { return false; }
}

function setAuthUI({ state, text }) {
  const dot = $("authDot");
  dot.classList.remove("ok", "bad");
  if (state === "ok")  dot.classList.add("ok");
  if (state === "bad") dot.classList.add("bad");
  $("authText").textContent = text;
}

function fmtK(n) {
  if (!Number.isFinite(+n)) return String(n);
  const x = +n;
  if (x >= 1e6) return (x/1e6).toFixed(1).replace(/\.0$/, "") + "M";
  if (x >= 1e3) return (x/1e3).toFixed(1).replace(/\.0$/, "") + "K";
  return String(x);
}

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let MODELS       = [];
let FILTERED     = [];
let MESSAGES     = [];
let RUN_ID       = 0;
let LAST_TEXT    = "";
let LAST_MODEL   = "";
let STOP_REQ     = false;
let PROMPT_HIST  = [];
let HIST_IDX     = -1;

function buildStateObject() {
  return {
    v: 4,
    theme: document.documentElement.getAttribute("data-theme") || "dark",
    system: $("system").value,
    optStream: $("optStream").checked,
    optMaxTokens: $("optMaxTokens").value,
    optTemp: $("optTemp").value,
    modelSelect: $("modelSelect").value,
    providerFilter: $("providerFilter").value,
    sortBy: $("sortBy").value,
    messages: MESSAGES.slice(-50)
  };
}

function saveState() {
  try { localStorage.setItem(APP.LS_KEY, JSON.stringify(buildStateObject())); } catch {}
}

function loadSavedState() {
  try {
    const raw = localStorage.getItem(APP.LS_KEY);
    return raw ? JSON.parse(raw) : null;
  } catch { return null; }
}

function applySettings(st) {
  if (!st) return;
  if (st.theme) setTheme(st.theme);
  if (typeof st.system === "string") $("system").value = st.system;
  if (typeof st.optStream === "boolean") $("optStream").checked = st.optStream;
  if (st.optMaxTokens != null) $("optMaxTokens").value = st.optMaxTokens;
  if (st.optTemp != null) $("optTemp").value = st.optTemp;
  if (Array.isArray(st.messages)) { MESSAGES = st.messages; renderChat(); }
}

let _saveTimer = null;
function debounceSave() {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(saveState, 500);
}

// ‚îÄ‚îÄ‚îÄ Models ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function normalizeModel(m) {
  const id = m.id ?? "", provider = m.provider ?? "", name = m.name ?? "";
  const free = id.includes(":free") || (m.cost && m.cost.input === 0);
  const tags = [free ? "FREE" : "", m.context ? `ctx ${fmtK(m.context)}` : ""].filter(Boolean).join(" ¬∑ ");
  return { ...m, _label: `${provider} ‚Äî ${name || id}${tags ? " ("+tags+")" : ""}`, _free: free };
}

function applyFilters() {
  const q = $("modelSearch").value.trim().toLowerCase();
  const prov = $("providerFilter").value;
  const sort = $("sortBy").value;

  FILTERED = MODELS.filter(m => {
    if (prov && prov !== "__all__" && m.provider !== prov) return false;
    if (!q) return true;
    return `${m.id} ${m.provider} ${m.name}`.toLowerCase().includes(q);
  });

  if (sort === "alpha") FILTERED.sort((a,b) => a.id.localeCompare(b.id));
  else if (sort === "context_desc") FILTERED.sort((a,b) => (+b.context||0) - (+a.context||0));
  else FILTERED.sort((a,b) => (a._free === b._free ? 0 : a._free ? -1 : 1));

  const sel = $("modelSelect");
  const selCmp = $("compareSelect");
  const cur = sel.value;
  const curCmp = Array.from(selCmp.selectedOptions).map(o=>o.value);

  sel.innerHTML = ""; selCmp.innerHTML = "";
  
  FILTERED.forEach(m => {
    const o1 = new Option(m._label, m.id);
    const o2 = new Option(m._label, m.id);
    if(m.id === cur) o1.selected = true;
    if(curCmp.includes(m.id)) o2.selected = true;
    sel.appendChild(o1);
    selCmp.appendChild(o2);
  });

  $("modelCount").textContent = `${FILTERED.length} / ${MODELS.length}`;
}

// ‚îÄ‚îÄ‚îÄ UI & Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateEmptyState() {
  const empty = $("emptyState");
  if (empty) empty.style.display = MESSAGES.filter(m => m.role !== "system").length ? "none" : "flex";
}

function renderChat() {
  const box = $("chatBody");
  box.querySelectorAll(".msg").forEach(el => el.remove());
  MESSAGES.filter(m => m.role !== "system").forEach((msg, i) => box.appendChild(buildMsgEl(msg, i)));
  box.scrollTop = box.scrollHeight;
  updateEmptyState();
}

function buildMsgEl(msg, idx) {
  const wrap = document.createElement("div");
  wrap.className = "msg " + (msg.role === "user" ? "user" : "assistant");
  
  const av = document.createElement("div"); av.className = "avatar";
  av.textContent = msg.role === "user" ? "U" : "AI";
  
  const content = document.createElement("div"); content.className = "msg-content";
  const bubble = document.createElement("div"); bubble.className = "bubble md";
  
  // Markdown Render
  bubble.innerHTML = mdToHtml(msg.content ?? "");
  attachCopyButtons(bubble);

  const actions = document.createElement("div"); actions.className = "msg-actions";
  const stampEl = document.createElement("span"); stampEl.className = "stamp"; stampEl.textContent = stamp();
  
  const copyBtn = document.createElement("button"); copyBtn.className = "btn ghost sm"; copyBtn.textContent = "‚éò Copiar Texto";
  copyBtn.onclick = () => copyText(msg.content);

  actions.append(stampEl, copyBtn);
  content.append(bubble, actions);
  wrap.append(av, content);
  return wrap;
}

function pushMessage(role, content) {
  MESSAGES.push({ role, content, ts: Date.now() });
  const box = $("chatBody");
  box.appendChild(buildMsgEl(MESSAGES[MESSAGES.length - 1], MESSAGES.length - 1));
  box.scrollTop = box.scrollHeight;
  updateEmptyState();
  debounceSave();
}

function updateLastBubble(text) {
  const bubbles = $("chatBody").querySelectorAll(".msg.assistant .bubble");
  if (!bubbles.length) return;
  const last = bubbles[bubbles.length - 1];
  last.innerHTML = mdToHtml(text);
  attachCopyButtons(last);
}

function setBusy(on, text = "Gerando‚Ä¶") {
  $("btnSend").disabled = on;
  $("btnStop").disabled = !on;
  $("loaderText").textContent = text;
  $("loader").classList.toggle("on", on);
}

function setErr(text) {
  const e = $("errBox");
  e.classList.toggle("on", !!text);
  e.textContent = text || "";
}

// ‚îÄ‚îÄ‚îÄ AI Interaction ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function askAI(userText) {
  setErr("");
  const text = (userText || $("prompt").value).trim();
  if (!text) return toast("Digite uma mensagem.", "warn");
  
  if (!await isSignedIn()) return toast("Fa√ßa login no Puter primeiro.", "err");

  const modelId = $("modelSelect").value;
  if(!modelId) return toast("Selecione um modelo.", "err");

  const stream = $("optStream").checked;
  const sys = $("system").value.trim();
  
  PROMPT_HIST.unshift(text);
  $("prompt").value = "";
  updateCharCounter();

  pushMessage("user", text);
  
  const msgs = MESSAGES.filter(m => m.role !== "system");
  if(sys) msgs.unshift({ role: "system", content: sys });

  setBusy(true, stream ? "Streaming‚Ä¶" : "Pensando‚Ä¶");
  const myRun = ++RUN_ID; STOP_REQ = false;
  const t0 = performance.now();

  try {
    const opt = { model: modelId, stream, temperature: +$("optTemp").value };
    if($("optMaxTokens").value) opt.max_tokens = +$("optMaxTokens").value;

    const resp = await puter.ai.chat(msgs, opt);
    
    if (stream && resp?.[Symbol.asyncIterator]) {
      let acc = "";
      pushMessage("assistant", "");
      for await (const chunk of resp) {
        if (STOP_REQ || RUN_ID !== myRun) break;
        acc += chunk?.text ?? "";
        MESSAGES[MESSAGES.length - 1].content = acc;
        LAST_TEXT = acc;
        updateLastBubble(acc);
      }
    } else {
      const txt = resp?.message?.content ?? String(resp);
      LAST_TEXT = txt;
      pushMessage("assistant", txt);
    }
    
    const dt = ((performance.now() - t0)/1000).toFixed(1);
    $("footMeta").textContent = `${modelId} ¬∑ ${dt}s`;
    logLine(`Chat OK: ${modelId} in ${dt}s`);
  } catch(e) {
    setErr("Falha na API: " + e.message);
    logLine("Erro: " + e.message, "error");
  } finally {
    setBusy(false);
  }
}

// ‚îÄ‚îÄ‚îÄ Image Generation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateImage() {
  const prompt = $("imgPrompt").value.trim();
  if(!prompt) return toast("Digite um prompt para a imagem.", "warn");
  if (!await isSignedIn()) return toast("Fa√ßa login no Puter.", "err");

  const grid = $("imgGrid");
  if(grid.querySelector('.empty-state')) grid.innerHTML = '';

  const btn = $("btnGenerateImage");
  btn.disabled = true;
  btn.innerText = "Gerando...";
  toast("Iniciando gera√ß√£o...", "info");

  try {
    const imgElement = await puter.ai.txt2img(prompt);
    
    const card = document.createElement('div');
    card.className = 'img-card';
    card.appendChild(imgElement);
    
    const desc = document.createElement('div');
    desc.className = 'img-prompt';
    desc.innerText = prompt;
    card.appendChild(desc);

    grid.prepend(card);
    toast("Imagem gerada com sucesso!", "ok");
    logLine("Imagem gerada: " + prompt.substring(0,30));
  } catch(e) {
    toast("Erro ao gerar imagem", "err");
    logLine("Erro txt2img: " + e.message, "error");
  } finally {
    btn.disabled = false;
    btn.innerText = "Gerar Imagem";
  }
}

// ‚îÄ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function copyText(text) {
  if (!text) return;
  try { await navigator.clipboard.writeText(text); toast("Copiado!", "ok"); }
  catch { toast("Erro ao copiar", "err"); }
}

function updateCharCounter() {
  const text = $("prompt").value;
  $("charCounter").textContent = text.length + " chars";
  // Rough token estimation (~4 chars per token for english, slightly higher for code/PT)
  const tokens = Math.ceil(text.length / 4);
  $("tokenCounter").textContent = `~ ${tokens} tokens`;
}

function setTheme(theme) {
  document.documentElement.setAttribute("data-theme", theme);
  const hlLink = document.getElementById('hl-theme');
  if(theme === 'light') hlLink.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css";
  else hlLink.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css";
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  applySettings(loadSavedState());
  
  if (!await waitForPuter(8000)) {
    return setAuthUI({ state: "bad", text: "Erro SDK Puter" });
  }

  setAuthUI({ state: "bad", text: "Verificando Auth..." });
  if(await isSignedIn()) {
    const u = await puter.auth.getUser();
    setAuthUI({ state: "ok", text: u?.username || "Autenticado" });
    $("btnSignIn").textContent = "Conta";
  } else {
    setAuthUI({ state: "bad", text: "Necess√°rio Login" });
  }

  // Load Models
  try {
    const raw = await puter.ai.listModels();
    MODELS = raw.map(normalizeModel);
    
    const provs = [...new Set(MODELS.map(m=>m.provider))].sort();
    $("providerFilter").innerHTML = `<option value="__all__">Todos Providers</option>` + provs.map(p=>`<option value="${p}">${p}</option>`).join('');
    
    applyFilters();
    toast(`${MODELS.length} modelos carregados!`, "ok");
  } catch(e) { logLine("Erro ao carregar modelos: "+e.message, "error"); }

  // Listeners
  $("btnSignIn").onclick = async () => { await puter.auth.signIn(); location.reload(); };
  $("btnTheme").onclick = () => {
    const n = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
    setTheme(n); debounceSave();
  };
  $("btnCollapse").onclick = () => $("sidebar").classList.toggle(window.innerWidth > 900 ? "collapsed" : "mobile-open");
  
  $("btnSend").onclick = () => askAI();
  $("btnStop").onclick = () => { STOP_REQ = true; };
  $("btnClear").onclick = () => { MESSAGES = []; renderChat(); debounceSave(); };
  $("prompt").oninput = updateCharCounter;
  
  $("modelSearch").oninput = applyFilters;
  $("providerFilter").onchange = applyFilters;
  $("sortBy").onchange = applyFilters;

  $("btnGenerateImage").onclick = generateImage;

  // Tabs
  document.querySelectorAll(".tab").forEach(t => t.onclick = () => {
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    document.querySelectorAll(".view").forEach(x => x.classList.remove("active"));
    t.classList.add("active");
    $("view-" + t.dataset.tab).classList.add("active");
  });

  $("prompt").onkeydown = e => {
    if (e.ctrlKey && e.key === "Enter") { e.preventDefault(); askAI(); }
  };
}

init();
</script>
</body>
</html>
